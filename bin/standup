#!/usr/bin/env bash
# AI Standup System - Launches specialized OpenCode roles for team standup
# Usage: ./bin/standup [--project-name <name>]

set -e

# Require Bash 4.0 or higher for associative arrays
if ((BASH_VERSINFO[0] < 4)); then
    echo "Error: This script requires Bash 4.0 or higher (you have $BASH_VERSION)"
    echo ""
    echo "On macOS, install with:"
    echo "  brew install bash"
    echo ""
    echo "Then make sure Homebrew bash is in your PATH before /bin/bash"
    exit 1
fi

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Determine project root and name
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
PROJECT_NAME_DEFAULT="$(basename "$PROJECT_ROOT")"
STANDUP_DIR="$PROJECT_ROOT/.standup"
TODAY=$(date +%Y-%m-%d)
TIME=$(date +%H:%M)

# Parse arguments
PROJECT_NAME="$PROJECT_NAME_DEFAULT"
FIRST_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --project-name)
            PROJECT_NAME="$2"
            shift 2
            ;;
        --first-run)
            FIRST_RUN=true
            shift
            ;;
        -h|--help)
            echo "AI Standup System"
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  --project-name <name>  Override project name (default: directory name)"
            echo "  --first-run           Run first-time setup wizard"
            echo "  -h, --help            Show this help message"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use -h for help"
            exit 1
            ;;
    esac
done

# Role definitions (role â†’ display name)
declare -A ROLES=(
    ["architect"]="Architect (System Designer)"
    ["developer"]="Developer (Bug Fixer)"
    ["qa-engineer"]="QA Engineer"
    ["code-reviewer"]="Code Reviewer"
)

# Role order for launch
ROLE_ORDER=("architect" "developer" "qa-engineer" "code-reviewer")

# Check dependencies
check_dependencies() {
    local missing=()
    
    if ! command -v opencode &> /dev/null; then
        missing+=("opencode")
    fi
    
    if ! command -v jq &> /dev/null; then
        missing+=("jq")
    fi
    
    if ! command -v tmux &> /dev/null; then
        missing+=("tmux")
    fi
    
    if ! command -v gh &> /dev/null; then
        echo -e "${YELLOW}Warning: 'gh' (GitHub CLI) not found. PR features will be limited.${NC}"
        local os=$(detect_os)
        case "$os" in
            macos)
                echo -e "${YELLOW}Install with: brew install gh${NC}"
                ;;
            *)
                echo -e "${YELLOW}Install with: sudo apt install gh${NC}"
                ;;
        esac
        echo
    fi
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing required dependencies: ${missing[*]}${NC}"
        echo
        echo "Install them with:"
        local os=$(detect_os)
        for dep in "${missing[@]}"; do
            case $dep in
                jq)
                    case "$os" in
                        macos)
                            echo "  brew install jq"
                            ;;
                        *)
                            echo "  sudo apt install jq"
                            ;;
                    esac
                    ;;
                tmux)
                    case "$os" in
                        macos)
                            echo "  brew install tmux"
                            ;;
                        *)
                            echo "  sudo apt install tmux"
                            ;;
                    esac
                    ;;
                opencode)
                    echo "  curl -fsSL https://opencode.ai/install | bash"
                    ;;
            esac
        done
        exit 1
    fi
}

# Initialize standup directory structure
initialize_standup_dirs() {
    echo -e "${BLUE}Initializing standup directory structure...${NC}"
    
    for role in "${!ROLES[@]}"; do
        mkdir -p "$STANDUP_DIR/$role"
        
        # Create empty tasks.json if it doesn't exist
        if [[ ! -f "$STANDUP_DIR/$role/tasks.json" ]]; then
            cat > "$STANDUP_DIR/$role/tasks.json" <<'EOF'
{
  "tasks": []
}
EOF
            echo -e "${GREEN}  âœ“ Created tasks.json for $role${NC}"
        fi
        
        # Create today's log if it doesn't exist
        if [[ ! -f "$STANDUP_DIR/$role/log-$TODAY.md" ]]; then
            cat > "$STANDUP_DIR/$role/log-$TODAY.md" <<EOF
# ${ROLES[$role]} Log - $TODAY

## Morning Standup ($TIME)
**Completed Recently:**
- [First standup - no previous work]

**Working On Today:**
- Waiting for assignments

**Blockers:**
- None

---

EOF
            echo -e "${GREEN}  âœ“ Created log for $role${NC}"
        fi
    done
    
    # Create notifications.md if it doesn't exist
    if [[ ! -f "$STANDUP_DIR/notifications.md" ]]; then
        cat > "$STANDUP_DIR/notifications.md" <<EOF
# Team Notifications

> Last standup: $TODAY $TIME

---

## ğŸ”´ URGENT (Requires immediate attention)

[No urgent notifications]

---

## ğŸŸ¡ IMPORTANT (Review when available)

[No important notifications]

---

## ğŸŸ¢ FYI (General updates)

**[$TIME] System:**
Standup system initialized. All roles ready to begin work.

---

EOF
        echo -e "${GREEN}  âœ“ Created notifications.md${NC}"
    fi
    
    # Record session start time for shutdown report
    echo "$TODAY $TIME" > "$STANDUP_DIR/.session-start"
    
    echo -e "${GREEN}  âœ“ Standup directories ready${NC}"
    echo
}

# Check if an OpenCode session exists
session_exists() {
    local session_name=$1
    opencode session list --format json 2>/dev/null | \
        jq -r '.[].id' 2>/dev/null | \
        grep -q "^${session_name}$"
}

# Detect operating system
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ -f "/proc/version" ]] && grep -qi "microsoft" /proc/version 2>/dev/null; then
        echo "wsl"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    else
        echo "unknown"
    fi
}

# Create tmux configuration for vim-like navigation
setup_tmux_config() {
    local tmux_conf="$STANDUP_DIR/.tmux.conf"
    
    cat > "$tmux_conf" <<'EOF'
# Vim-style pane navigation with Ctrl+hjkl
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R

# Enable mouse support
set -g mouse on

# Set status bar
set -g status-style bg=colour235,fg=colour255
set -g status-left-length 30
set -g status-left '#[fg=green]AI Standup #[fg=cyan]#{session_name} '
set -g status-right '#[fg=yellow]%Y-%m-%d %H:%M'

# Pane border colors
set -g pane-border-style fg=colour238
set -g pane-active-border-style fg=colour39

# Pane titles
set -g pane-border-status top
set -g pane-border-format ' #{pane_title} '
EOF
    
    echo "$tmux_conf"
}

# Create wrapper script for role in tmux pane
create_agent_wrapper() {
    local role=$1
    local session_name="$PROJECT_NAME-$role-$TODAY"
    local prompt=$(generate_standup_prompt "$role")
    local wrapper_script="$STANDUP_DIR/${role}-wrapper.sh"
    local prompt_file="$STANDUP_DIR/${role}-prompt.txt"
    
    # Save the prompt to a file
    echo "$prompt" > "$prompt_file"
    
    # Check if session exists
    local continue_flag=""
    if session_exists "$session_name"; then
        continue_flag="--continue"
    fi
    
    # Create wrapper script
    cat > "$wrapper_script" <<EOF
#!/bin/bash
cd "$PROJECT_ROOT" || exit 1

# Set pane title
printf '\033]2;%s\033\\' "${ROLES[$role]}"

# Run opencode with the prompt from file
if [ "$continue_flag" = "--continue" ]; then
    opencode --session "$session_name" --continue --prompt "\$(cat '$prompt_file')"
else
    opencode --session "$session_name" --prompt "\$(cat '$prompt_file')"
fi

# Keep pane open on exit
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Session ended. Press Enter to close..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
read -r
EOF
    
    chmod +x "$wrapper_script"
    echo "$wrapper_script"
}

# Generate standup prompt for each role
generate_standup_prompt() {
    local role=$1
    
    # Check for previous session summary
    local previous_summary=""
    local latest_summary=$(ls -t "$STANDUP_DIR/$role"/session-summary-*.md 2>/dev/null | head -1)
    
    if [[ -n "$latest_summary" && -f "$latest_summary" ]]; then
        local summary_date=$(basename "$latest_summary" | sed 's/session-summary-\(.*\)\.md/\1/')
        previous_summary="
## Previous Session Summary ($summary_date)

\`\`\`
$(cat "$latest_summary")
\`\`\`

Please review this to understand where you left off.
"
    fi
    
    # Check for previous day's log
    local previous_log=""
    local latest_log=$(ls -t "$STANDUP_DIR/$role"/log-*.md 2>/dev/null | grep -v "log-$TODAY.md" | head -1)
    
    if [[ -n "$latest_log" && -f "$latest_log" ]]; then
        local log_date=$(basename "$latest_log" | sed 's/log-\(.*\)\.md/\1/')
        previous_log="
## Previous Day's Log ($log_date)

Review \`.standup/$role/$(basename "$latest_log")\` for detailed history.
"
    fi
    
    cat <<EOF
Good morning! It's standup time. ğŸŒ…

**Your Role:** ${ROLES[$role]}
**Date:** $TODAY
**Time:** $TIME

Please start by loading your skill to understand your responsibilities:

\`\`\`
/skill $role
\`\`\`
$previous_summary$previous_log
## Your Tasks for Today

1. **Check Notifications:** Read \`.standup/notifications.md\` for urgent items
2. **Read Your Progress:**
   - Daily log: \`.standup/$role/log-$TODAY.md\`
   - Task list: \`.standup/$role/tasks.json\`
3. **Give Your Update:** Follow the format in your skill

After your update, wait for today's assignments and priorities.

## Throughout the Day

- Update your progress files as you work
- Check notifications every 30-60 minutes
- Post notifications for important events
- Work autonomously based on your assignments

## End of Session

When the session ends, you'll be prompted to create a summary.
Your summary should include:
- Key accomplishments
- Work in progress
- Files modified
- Recommendations for next session

Let's have a great standup! ğŸš€
EOF
}

# Launch tmux session with all roles in a 2x2 grid
launch_tmux_standup() {
    local tmux_session="standup-$PROJECT_NAME-$TODAY"
    
    echo -e "${BOLD}Launching roles in tmux session...${NC}"
    echo
    
    # Setup tmux configuration
    local tmux_conf=$(setup_tmux_config)
    
    # Check if tmux session already exists
    if tmux has-session -t "$tmux_session" 2>/dev/null; then
        echo -e "${YELLOW}Tmux session '$tmux_session' already exists.${NC}"
        echo -e "${YELLOW}Attaching to existing session...${NC}"
        echo ""
        tmux attach-session -t "$tmux_session"
        exit 0
    fi
    
    # Create wrapper scripts for each role
    local -a wrapper_scripts
    local -a role_titles
    
    for role in "${ROLE_ORDER[@]}"; do
        local title="${ROLES[$role]}"
        local session_name="$PROJECT_NAME-$role-$TODAY"
        
        echo -e "${BLUE}Preparing ${BOLD}$title${NC}${BLUE}...${NC}"
        
        # Check if session exists
        if session_exists "$session_name"; then
            echo -e "  ${YELLOW}â†’ Continuing existing session${NC}"
        else
            echo -e "  ${GREEN}â†’ Creating new session${NC}"
        fi
        
        local wrapper=$(create_agent_wrapper "$role")
        wrapper_scripts+=("$wrapper")
        role_titles+=("$title")
    done
    
    echo ""
    echo -e "${GREEN}Creating tmux session: ${BOLD}$tmux_session${NC}"
    echo ""
    
    # Create new tmux session (detached) - only use -f here to load config
    if ! tmux -f "$tmux_conf" new-session -d -s "$tmux_session" -n "standup"; then
        echo -e "${RED}ERROR: Failed to create tmux session${NC}"
        exit 1
    fi
    
    # Get the window ID (could be 0 or 1 depending on base-index setting)
    local window_id
    window_id=$(tmux list-windows -t "$tmux_session" -F "#{window_index}" | head -1)
    
    # All subsequent commands work on the existing session (no -f needed)
    # Use $window_id instead of hardcoded 0
    
    # Pane 0: Architect (top-left) - already exists from new-session
    if ! tmux select-pane -t "$tmux_session:$window_id.0" -T "${role_titles[0]}"; then
        echo -e "${RED}ERROR: Failed to select pane 0${NC}"
        exit 1
    fi
    
    # Pane 1: Developer (top-right) - split horizontally from pane 0
    if ! tmux split-window -h -t "$tmux_session:$window_id.0"; then
        echo -e "${RED}ERROR: Failed to create pane 1${NC}"
        exit 1
    fi
    tmux select-pane -t "$tmux_session:$window_id.1" -T "${role_titles[1]}"
    
    # Pane 2: QA Engineer (bottom-left) - split vertically from pane 0
    if ! tmux split-window -v -t "$tmux_session:$window_id.0"; then
        echo -e "${RED}ERROR: Failed to create pane 2${NC}"
        exit 1
    fi
    tmux select-pane -t "$tmux_session:$window_id.2" -T "${role_titles[2]}"
    
    # Pane 3: Code Reviewer (bottom-right) - split vertically from pane 1
    if ! tmux split-window -v -t "$tmux_session:$window_id.1"; then
        echo -e "${RED}ERROR: Failed to create pane 3${NC}"
        exit 1
    fi
    tmux select-pane -t "$tmux_session:$window_id.3" -T "${role_titles[3]}"
    
    # Balance the panes to make them equal size
    tmux select-layout -t "$tmux_session:$window_id" tiled
    
    # Send commands to each pane
    tmux send-keys -t "$tmux_session:$window_id.0" "bash '${wrapper_scripts[0]}'" Enter
    tmux send-keys -t "$tmux_session:$window_id.1" "bash '${wrapper_scripts[1]}'" Enter
    tmux send-keys -t "$tmux_session:$window_id.2" "bash '${wrapper_scripts[2]}'" Enter
    tmux send-keys -t "$tmux_session:$window_id.3" "bash '${wrapper_scripts[3]}'" Enter
    
    # Select the first pane (Architect)
    tmux select-pane -t "$tmux_session:$window_id.0"
    
    echo -e "${GREEN}${BOLD}âœ“ All roles launched in tmux!${NC}"
    echo ""
    echo -e "${BOLD}Your AI team is ready in a 2x2 grid layout:${NC}"
    echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "  â”‚   Architect     â”‚   Developer     â”‚"
    echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "  â”‚  QA Engineer    â”‚ Code Reviewer   â”‚"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo -e "${BOLD}Navigation:${NC}"
    echo "  â€¢ Ctrl+h - Move to left pane"
    echo "  â€¢ Ctrl+j - Move to down pane"
    echo "  â€¢ Ctrl+k - Move to up pane"
    echo "  â€¢ Ctrl+l - Move to right pane"
    echo "  â€¢ Ctrl+b d - Detach from session (keeps roles running)"
    echo "  â€¢ Ctrl+b x - Close current pane"
    echo ""
    echo -e "${YELLOW}Pro Tips:${NC}"
    echo "  â€¢ Run 'standup-shutdown' to gracefully end session with summaries"
    echo "  â€¢ Run 'standup-metrics' in another terminal to see team performance"
    echo "  â€¢ Check '.standup/notifications.md' for role updates"
    echo "  â€¢ To reattach: tmux attach -t $tmux_session"
    echo ""
    echo "Press Enter to attach to the tmux session..."
    read
    
    # Attach to the session
    tmux attach-session -t "$tmux_session"
}

# First run setup wizard
first_run_setup() {
    echo -e "${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}â•‘     AI Standup System - First Run Setup Wizard        â•‘${NC}"
    echo -e "${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${BLUE}Welcome to the AI Standup System!${NC}"
    echo
    echo "This system creates a team of AI roles who work together:"
    echo "  â€¢ ${BOLD}Architect${NC} - Designs system architecture and guides technical decisions"
    echo "  â€¢ ${BOLD}Developer${NC} - Implements features and fixes bugs"
    echo "  â€¢ ${BOLD}QA Engineer${NC} - Tests features and finds bugs"
    echo "  â€¢ ${BOLD}Code Reviewer${NC} - Reviews code quality and suggests improvements"
    echo
    echo -e "${YELLOW}Each role maintains their own progress files and communicates via${NC}"
    echo -e "${YELLOW}a shared notification board.${NC}"
    echo
    echo "Press Enter to continue setup..."
    read
    
    echo
    echo -e "${BLUE}Setting up directory structure...${NC}"
    initialize_standup_dirs
    
    echo -e "${GREEN}${BOLD}âœ“ Setup complete!${NC}"
    echo
    echo -e "${BOLD}Next Steps:${NC}"
    echo "  1. Four roles will launch in a tmux 2x2 grid layout"
    echo "  2. Each role will give you a status update"
    echo "  3. Conduct your standup by assigning work to each role"
    echo "  4. Navigate between roles using Ctrl+hjkl"
    echo
    echo -e "${BOLD}Useful Commands:${NC}"
    echo "  ./bin/standup-metrics       - View team metrics dashboard"
    echo "  ./bin/standup-pr-status     - Check PR status"
    echo "  ./bin/standup-summary       - Generate daily summary"
    echo
    echo "  cat .standup/notifications.md   - Check team notifications"
    echo
    echo -e "${BOLD}Tips:${NC}"
    echo "  â€¢ Each role checks notifications automatically every 30-60 minutes"
    echo "  â€¢ Use priority levels: ğŸ”´ URGENT, ğŸŸ¡ IMPORTANT, ğŸŸ¢ FYI"
    echo "  â€¢ Roles will post to notifications.md when they need your attention"
    echo
    echo "Press Enter to launch your AI team..."
    read
}

# Main execution
main() {
    # Check dependencies first
    check_dependencies
    
    # Detect first run
    if [[ ! -d "$STANDUP_DIR" ]]; then
        FIRST_RUN=true
    fi
    
    # Run first-time setup if needed
    if [[ "$FIRST_RUN" = true ]]; then
        first_run_setup
    else
        initialize_standup_dirs
    fi
    
    echo -e "${GREEN}${BOLD}========================================${NC}"
    echo -e "${GREEN}${BOLD}   AI Team Standup - $TODAY $TIME${NC}"
    echo -e "${GREEN}${BOLD}========================================${NC}"
    echo
    echo -e "${BLUE}Project:${NC} $PROJECT_NAME"
    echo -e "${BLUE}Location:${NC} $PROJECT_ROOT"
    echo
    
    # Launch all roles in tmux
    launch_tmux_standup
}

main "$@"
