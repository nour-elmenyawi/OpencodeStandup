#!/usr/bin/env bash
# Standup PR Status - Quick overview of pull request status

set -e

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# Color codes
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# Check if gh is installed
if ! command -v gh &> /dev/null; then
    echo -e "${RED}Error: GitHub CLI (gh) is not installed${NC}"
    
    # Detect OS for install instructions
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "Install with: brew install gh"
    else
        echo "Install with: sudo apt install gh"
    fi
    echo "Or visit: https://cli.github.com/"
    exit 1
fi

# Check if we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Check if gh is authenticated
if ! gh auth status &> /dev/null; then
    echo -e "${YELLOW}GitHub CLI not authenticated${NC}"
    echo "Run: gh auth login"
    exit 1
fi

echo -e "${BOLD}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BOLD}‚ïë           Pull Request Status Dashboard               ‚ïë${NC}"
echo -e "${BOLD}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
echo

# Show open PRs
echo -e "${BOLD}üìÇ Open Pull Requests${NC}"
echo

open_prs=$(gh pr list --json number,title,author,reviews,reviewDecision,statusCheckRollup,updatedAt --limit 20 2>/dev/null || echo "[]")

if [[ "$open_prs" == "[]" || "$open_prs" == "" ]]; then
    echo -e "${GREEN}  No open pull requests${NC}"
else
    echo "$open_prs" | jq -r '.[] | 
        "PR #\(.number): \(.title)\n" +
        "  Author: \(.author.login)\n" +
        "  Reviews: \(.reviews | length) review(s)\n" +
        "  Status: \(if .reviewDecision == "APPROVED" then "‚úÖ Approved" 
                    elif .reviewDecision == "CHANGES_REQUESTED" then "‚ùå Changes Requested"
                    elif .reviewDecision == "REVIEW_REQUIRED" then "‚è≥ Review Required"
                    else "‚è≥ Pending" end)\n" +
        "  Checks: \(if .statusCheckRollup then 
                      if (.statusCheckRollup | length) > 0 then
                        "\(.statusCheckRollup | map(select(.conclusion == "SUCCESS")) | length)/\(.statusCheckRollup | length) passing"
                      else "No checks"
                      end
                    else "No checks" end)\n" +
        "  Updated: \(.updatedAt)\n"' | sed 's/^/  /'
fi

echo

# Show recently merged PRs
echo -e "${BOLD}‚úÖ Recently Merged PRs (Last 7 Days)${NC}"
echo

merged_prs=$(gh pr list --state merged --json number,title,mergedAt,mergedBy --limit 50 2>/dev/null || echo "[]")

if [[ "$merged_prs" == "[]" || "$merged_prs" == "" ]]; then
    echo -e "${YELLOW}  No recently merged PRs${NC}"
else
    # Filter to last 7 days and display
    recent_merged=$(echo "$merged_prs" | jq --arg cutoff "$(date -d '7 days ago' -Iseconds 2>/dev/null || date -v-7d -Iseconds 2>/dev/null)" \
        '[.[] | select(.mergedAt > $cutoff)]')
    
    if [[ "$recent_merged" == "[]" ]]; then
        echo -e "${YELLOW}  No PRs merged in the last 7 days${NC}"
    else
        echo "$recent_merged" | jq -r '.[] | 
            "  PR #\(.number): \(.title)\n" +
            "    Merged by: \(.mergedBy.login) on \(.mergedAt | split("T")[0])"'
    fi
fi

echo

# Show PR stats summary
echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${BOLD}Summary${NC}"
echo

open_count=$(echo "$open_prs" | jq 'length' 2>/dev/null || echo 0)
approved_count=$(echo "$open_prs" | jq '[.[] | select(.reviewDecision == "APPROVED")] | length' 2>/dev/null || echo 0)
changes_requested_count=$(echo "$open_prs" | jq '[.[] | select(.reviewDecision == "CHANGES_REQUESTED")] | length' 2>/dev/null || echo 0)
needs_review_count=$(echo "$open_prs" | jq '[.[] | select(.reviewDecision == null or .reviewDecision == "REVIEW_REQUIRED")] | length' 2>/dev/null || echo 0)
merged_7d_count=$(echo "$recent_merged" | jq 'length' 2>/dev/null || echo 0)

echo -e "  Open PRs: ${BLUE}$open_count${NC}"
echo -e "  Approved: ${GREEN}$approved_count${NC}"
echo -e "  Changes Requested: ${RED}$changes_requested_count${NC}"
echo -e "  Needs Review: ${YELLOW}$needs_review_count${NC}"
echo -e "  Merged (7d): ${GREEN}$merged_7d_count${NC}"
echo

if [[ $needs_review_count -gt 0 ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  $needs_review_count PR(s) need review${NC}"
fi

if [[ $changes_requested_count -gt 0 ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  $changes_requested_count PR(s) have requested changes${NC}"
fi

echo
